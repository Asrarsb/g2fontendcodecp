cat << 'EOF' > buildspec.yml
version: 0.2
phases:
  install:
    commands:
      - echo Installing Node.js 22.11.0...
      - curl --version || echo "curl not found"
      - curl -fsSL https://nodejs.org/dist/v22.11.0/node-v22.11.0-linux-x64.tar.xz | tar -xJ -C /usr/local --strip-components=1
      - node --version
      - npm --version
      - docker --version || echo "Docker not installed"
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region ap-northeast-3 | docker login --username AWS --password-stdin 124355663661.dkr.ecr.ap-northeast-3.amazonaws.com
  build:
    commands:
      - echo Build started...
      - ls -la
      - cat package.json || echo "package.json not found"
      - rm -rf node_modules/ package-lock.json
      - echo Running npm install...
      - npm install
      - echo Environment variables...
      - echo REACT_APP_API_URL_IDEA=$REACT_APP_API_URL_IDEA
      - echo REACT_APP_API_URL_COMMENT=$REACT_APP_API_URL_COMMENT
      - echo REACT_APP_API_URL_USER=$REACT_APP_API_URL_USER
      - echo REACT_APP_API_URL_MESSAGE=$REACT_APP_API_URL_MESSAGE
      - echo Running docker build...
      - set -e
      - docker build \
        --build-arg REACT_APP_API_URL_IDEA="$REACT_APP_API_URL_IDEA" \
        --build-arg REACT_APP_API_URL_COMMENT="$REACT_APP_API_URL_COMMENT" \
        --build-arg REACT_APP_API_URL_USER="$REACT_APP_API_URL_USER" \
        --build-arg REACT_APP_API_URL_MESSAGE="$REACT_APP_API_URL_MESSAGE" \
        -t 124355663661.dkr.ecr.ap-northeast-3.amazonaws.com/g2-frontend-cp:test . || { echo "Docker build failed"; exit 1; }
  post_build:
    commands:
      - echo Pushing Docker image...
      - docker push 124355663661.dkr.ecr.ap-northeast-3.amazonaws.com/g2-frontend-cp:test
      - echo Writing imagedefinitions.json...
      - printf '[{"name":"frontend-container","imageUri":"%s"}]' 124355663661.dkr.ecr.ap-northeast-3.amazonaws.com/g2-frontend-cp:test > imagedefinitions.json
      - cat imagedefinitions.json
artifacts:
  files:
    - imagedefinitions.json
EOF
